// Prisma Schema for GitScan

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores GitHub authenticated users
model User {
  id              String    @id @default(uuid())
  githubId        String    @unique
  username        String    @unique
  email           String?
  avatarUrl       String?
  accessToken     String    // Encrypted GitHub access token
  refreshToken    String?   // Encrypted refresh token

  // User preferences
  defaultLlmProvider LlmProvider @default(OPENAI)

  // Stripe/Subscription fields
  stripeCustomerId    String?   @unique
  subscriptionId      String?   @unique
  subscriptionStatus  SubscriptionStatus @default(FREE)
  plan                PlanType  @default(FREE)
  planExpiresAt       DateTime?

  // Usage tracking (monthly reset)
  scansUsedThisMonth  Int       @default(0)
  reposUsedThisMonth  Int       @default(0)
  fixesUsedThisMonth  Int       @default(0)
  usageResetAt        DateTime  @default(now())

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime  @default(now())

  // Relations
  repositories    Repository[]
  scans           Scan[]
  apiKeys         UserApiKey[]
  invoices        Invoice[]
  pentestRuns     PentestRun[]

  @@map("users")
}

// User's LLM API Keys
model UserApiKey {
  id          String      @id @default(uuid())
  userId      String
  provider    LlmProvider
  apiKey      String      // Encrypted
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("user_api_keys")
}

// Repository model - GitHub repositories selected for scanning
model Repository {
  id              String    @id @default(uuid())
  userId          String
  githubRepoId    String
  name            String
  fullName        String    // owner/repo format
  description     String?
  defaultBranch   String    @default("main")
  language        String?
  isPrivate       Boolean   @default(false)
  htmlUrl         String
  cloneUrl        String

  // Scanning configuration
  autoScanEnabled Boolean   @default(false)
  scanOnPush      Boolean   @default(false)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastScannedAt   DateTime?

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  scans           Scan[]
  pentestRuns     PentestRun[]

  @@unique([userId, githubRepoId])
  @@map("repositories")
}

// Scan model - represents a security scan execution
model Scan {
  id              String      @id @default(uuid())
  userId          String
  repositoryId    String

  // Scan configuration
  branch          String
  commitHash      String?
  scanType        ScanType    @default(FULL)

  // Status tracking
  status          ScanStatus  @default(PENDING)
  progress        Int         @default(0) // 0-100

  // Results summary
  totalFiles      Int         @default(0)
  filesScanned    Int         @default(0)

  // Vulnerability counts by severity
  criticalCount   Int         @default(0)
  highCount       Int         @default(0)
  mediumCount     Int         @default(0)
  lowCount        Int         @default(0)
  infoCount       Int         @default(0)

  // Timing
  startedAt       DateTime?
  completedAt     DateTime?

  // Error handling
  errorMessage    String?

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository      Repository  @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  vulnerabilities Vulnerability[]
  reports         Report[]

  @@map("scans")
}

// Vulnerability model - individual security issues found
model Vulnerability {
  id              String            @id @default(uuid())
  scanId          String

  // Vulnerability details
  title           String
  description     String
  severity        Severity
  category        VulnerabilityCategory

  // Location in code
  filePath        String
  startLine       Int
  endLine         Int
  codeSnippet     String?           @db.Text

  // CWE/CVE references
  cweId           String?           // e.g., CWE-79
  cveId           String?           // e.g., CVE-2023-1234

  // Fix suggestions
  suggestedFix    String?           @db.Text
  fixConfidence   Float?            // 0.0 - 1.0
  autoFixAvailable Boolean          @default(false)

  // Status tracking
  status          VulnerabilityStatus @default(OPEN)
  falsePositive   Boolean           @default(false)

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  scan            Scan              @relation(fields: [scanId], references: [id], onDelete: Cascade)
  fixes           Fix[]

  @@map("vulnerabilities")
}

// Fix model - automatic fix attempts
model Fix {
  id              String      @id @default(uuid())
  vulnerabilityId String

  // Fix details
  originalCode    String      @db.Text
  fixedCode       String      @db.Text
  explanation     String?     @db.Text

  // LLM provider used
  llmProvider     LlmProvider
  llmModel        String?

  // Status
  status          FixStatus   @default(PENDING)
  appliedAt       DateTime?

  // Pull Request info
  prUrl           String?
  prNumber        Int?
  prStatus        PrStatus?

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  vulnerability   Vulnerability @relation(fields: [vulnerabilityId], references: [id], onDelete: Cascade)

  @@map("fixes")
}

// Report model - generated security reports
model Report {
  id              String      @id @default(uuid())
  scanId          String

  // Report details
  title           String
  format          ReportFormat @default(JSON)
  content         String       @db.Text

  // Summary data
  summary         Json?

  // Timestamps
  createdAt       DateTime     @default(now())

  // Relations
  scan            Scan         @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// Enums
enum LlmProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
}

enum ScanType {
  FULL
  QUICK
  CUSTOM
}

enum ScanStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum VulnerabilityCategory {
  XSS
  SQL_INJECTION
  COMMAND_INJECTION
  PATH_TRAVERSAL
  SSRF
  XXE
  DESERIALIZATION
  AUTHENTICATION
  AUTHORIZATION
  CRYPTOGRAPHY
  SECRETS_EXPOSURE
  DEPENDENCY
  CONFIGURATION
  CODE_QUALITY
  CSRF
  SESSION
  IDOR
  MASS_ASSIGNMENT
  OPEN_REDIRECT
  OTHER
}

enum VulnerabilityStatus {
  OPEN
  IN_PROGRESS
  FIXED
  WONT_FIX
  FALSE_POSITIVE
}

enum FixStatus {
  PENDING
  APPLIED
  FAILED
  REJECTED
}

enum PrStatus {
  OPEN
  MERGED
  CLOSED
}

enum ReportFormat {
  JSON
  HTML
  PDF
  MARKDOWN
}

// Subscription & Billing Enums
enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  PAST_DUE
  CANCELLED
  TRIALING
}

// Invoice model - tracks payment history
model Invoice {
  id              String        @id @default(uuid())
  userId          String
  stripeInvoiceId String        @unique

  // Invoice details
  amount          Int           // Amount in cents
  currency        String        @default("brl")
  status          InvoiceStatus
  description     String?

  // Period
  periodStart     DateTime
  periodEnd       DateTime

  // URLs
  invoicePdf      String?
  hostedInvoiceUrl String?

  // Timestamps
  paidAt          DateTime?
  createdAt       DateTime      @default(now())

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// Plan limits configuration (stored as reference)
// FREE: 3 repos, 10 scans/month, 5 AI fixes/month
// PRO: 20 repos, 100 scans/month, 50 AI fixes/month
// ENTERPRISE: Unlimited repos, Unlimited scans, Unlimited AI fixes

// ============================================================================
// Pentest Pipeline Models (Shannon Integration)
// ============================================================================

// PentestRun - Represents a complete pentest pipeline execution
model PentestRun {
  id              String        @id @default(uuid())
  userId          String
  repositoryId    String

  // Target information
  webUrl          String        // Target web application URL
  branch          String        @default("main")

  // Temporal workflow
  workflowId      String        @unique
  runId           String?

  // Status tracking
  status          PentestStatus @default(PENDING)
  currentPhase    String?       // Current phase name
  currentAgent    String?       // Current agent name
  completedAgents String[]      // List of completed agent names
  skippedAgents   String[]      // List of skipped agent names
  failedAgent     String?       // Agent that failed (if any)
  error           String?       @db.Text

  // Metrics
  totalCostUsd    Float?
  totalDurationMs Int?

  // Configuration
  configPath      String?       // Path to YAML config file
  auditLogPath    String?       // Path to audit logs

  // Timing
  startedAt       DateTime      @default(now())
  completedAt     DateTime?

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  repository      Repository    @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  agentRuns       AgentRun[]
  pentestReport   PentestReport?

  @@map("pentest_runs")
}

// AgentRun - Represents a single agent execution within a pentest
model AgentRun {
  id              String        @id @default(uuid())
  pentestRunId    String

  // Agent info
  agentName       String        // e.g., "pre-recon", "injection-vuln"
  phase           String        // e.g., "pre-recon", "vulnerability-analysis"

  // Status
  status          AgentStatus   @default(PENDING)
  attemptNumber   Int           @default(1)

  // Metrics
  durationMs      Int?
  costUsd         Float?
  inputTokens     Int?
  outputTokens    Int?
  numTurns        Int?
  model           String?       // LLM model used

  // Git checkpoint
  checkpoint      String?       // Git commit hash before execution
  commitHash      String?       // Git commit hash after success

  // Error handling
  error           String?       @db.Text

  // Timing
  startedAt       DateTime      @default(now())
  completedAt     DateTime?

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  pentestRun      PentestRun    @relation(fields: [pentestRunId], references: [id], onDelete: Cascade)

  @@map("agent_runs")
}

// PentestReport - Final security assessment report
model PentestReport {
  id              String        @id @default(uuid())
  pentestRunId    String        @unique

  // Report content
  content         String        @db.Text  // Full markdown report
  format          ReportFormat  @default(MARKDOWN)

  // Summary metrics
  summary         Json?         // Aggregated findings summary

  // Vulnerability counts
  criticalCount   Int           @default(0)
  highCount       Int           @default(0)
  mediumCount     Int           @default(0)
  lowCount        Int           @default(0)
  infoCount       Int           @default(0)

  // Exploit results
  exploitsAttempted Int         @default(0)
  exploitsSuccessful Int        @default(0)

  // Timestamps
  createdAt       DateTime      @default(now())

  // Relations
  pentestRun      PentestRun    @relation(fields: [pentestRunId], references: [id], onDelete: Cascade)

  @@map("pentest_reports")
}

// Pentest Status enum
enum PentestStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// Agent Status enum
enum AgentStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  SKIPPED
}
