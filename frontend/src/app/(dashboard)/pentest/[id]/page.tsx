'use client';

import { useState, useEffect, useRef } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import {
  Shield,
  ArrowLeft,
  ExternalLink,
  Clock,
  CheckCircle,
  CheckCircle2,
  XCircle,
  AlertCircle,
  Loader2,
  Timer,
  DollarSign,
  FileText,
  Download,
  Play,
  SkipForward,
  Target,
  Zap,
  Search,
  Bug,
  Lock,
  Globe,
  Users,
  AlertTriangle,
  FileCode,
  ChevronDown,
  ChevronUp,
} from 'lucide-react';
import toast from 'react-hot-toast';
import { pentestApi } from '@/lib/api';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { formatDate, formatRelativeTime } from '@/lib/utils';
import type {
  PentestRun,
  PentestProgress,
  AgentName,
  PhaseName,
  AgentStatus,
  AGENT_DEFINITIONS,
  PHASE_DEFINITIONS,
} from '@/types';

// Phase order for display
const PHASE_ORDER: PhaseName[] = [
  'pre-recon',
  'recon',
  'vulnerability-analysis',
  'exploitation',
  'reporting',
];

// Agent order within phases
const AGENT_ORDER: AgentName[] = [
  'pre-recon',
  'recon',
  'injection-vuln',
  'xss-vuln',
  'auth-vuln',
  'ssrf-vuln',
  'authz-vuln',
  'injection-exploit',
  'xss-exploit',
  'auth-exploit',
  'ssrf-exploit',
  'authz-exploit',
  'report',
];

// Agent icons mapping
const AGENT_ICONS: Record<AgentName, any> = {
  'pre-recon': FileCode,
  'recon': Search,
  'injection-vuln': AlertTriangle,
  'xss-vuln': Globe,
  'auth-vuln': Lock,
  'ssrf-vuln': Globe,
  'authz-vuln': Users,
  'injection-exploit': Zap,
  'xss-exploit': Zap,
  'auth-exploit': Zap,
  'ssrf-exploit': Zap,
  'authz-exploit': Zap,
  'report': FileText,
};

// Phase definitions with Portuguese labels
const PHASES: Record<PhaseName, { name: string; description: string }> = {
  'pre-recon': { name: 'Pré-Reconhecimento', description: 'Análise estática inicial' },
  'recon': { name: 'Reconhecimento', description: 'Mapeamento da aplicação' },
  'vulnerability-analysis': { name: 'Análise de Vulnerabilidades', description: 'Detecção de vulnerabilidades' },
  'exploitation': { name: 'Exploração', description: 'Validação de vulnerabilidades' },
  'reporting': { name: 'Relatório', description: 'Geração de relatório' },
};

// Agent definitions with Portuguese labels
const AGENTS: Record<AgentName, { name: string; description: string; phase: PhaseName }> = {
  'pre-recon': { name: 'Pre-Recon', description: 'Análise estática de código', phase: 'pre-recon' },
  'recon': { name: 'Reconhecimento', description: 'Mapeamento de superfície de ataque', phase: 'recon' },
  'injection-vuln': { name: 'Injection Vuln', description: 'Detecção de SQLi, Command Injection', phase: 'vulnerability-analysis' },
  'xss-vuln': { name: 'XSS Vuln', description: 'Detecção de Cross-Site Scripting', phase: 'vulnerability-analysis' },
  'auth-vuln': { name: 'Auth Vuln', description: 'Detecção de falhas de autenticação', phase: 'vulnerability-analysis' },
  'ssrf-vuln': { name: 'SSRF Vuln', description: 'Detecção de Server-Side Request Forgery', phase: 'vulnerability-analysis' },
  'authz-vuln': { name: 'Authz Vuln', description: 'Detecção de falhas de autorização', phase: 'vulnerability-analysis' },
  'injection-exploit': { name: 'Injection Exploit', description: 'Exploração de injeção', phase: 'exploitation' },
  'xss-exploit': { name: 'XSS Exploit', description: 'Exploração de XSS', phase: 'exploitation' },
  'auth-exploit': { name: 'Auth Exploit', description: 'Exploração de autenticação', phase: 'exploitation' },
  'ssrf-exploit': { name: 'SSRF Exploit', description: 'Exploração de SSRF', phase: 'exploitation' },
  'authz-exploit': { name: 'Authz Exploit', description: 'Exploração de autorização', phase: 'exploitation' },
  'report': { name: 'Relatório', description: 'Geração de relatório executivo', phase: 'reporting' },
};

function formatDuration(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (hours > 0) {
    return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
  }
  if (minutes > 0) {
    return `${minutes}m ${seconds % 60}s`;
  }
  return `${seconds}s`;
}

function formatCost(cost: number): string {
  return `$${cost.toFixed(4)}`;
}

function getAgentStatus(
  agentName: AgentName,
  currentAgent: AgentName | null,
  completedAgents: AgentName[],
  skippedAgents: AgentName[],
  failedAgent: AgentName | null
): AgentStatus {
  if (failedAgent === agentName) return 'FAILED';
  if (completedAgents.includes(agentName)) return 'COMPLETED';
  if (skippedAgents.includes(agentName)) return 'SKIPPED';
  if (currentAgent === agentName) return 'RUNNING';
  return 'PENDING';
}

export default function PentestDetailPage() {
  const params = useParams();
  const router = useRouter();
  const queryClient = useQueryClient();
  const pentestId = params.id as string;
  const eventSourceRef = useRef<EventSource | null>(null);

  const [progress, setProgress] = useState<PentestProgress | null>(null);
  const [showMetrics, setShowMetrics] = useState(true);
  const [showReport, setShowReport] = useState(true);

  // Fetch pentest details
  const { data: pentest, isLoading: loadingPentest } = useQuery({
    queryKey: ['pentest', pentestId],
    queryFn: async () => {
      const response = await pentestApi.getPentest(pentestId);
      return response.data.data as PentestRun;
    },
    refetchInterval: (query) => {
      const data = query.state.data as PentestRun | undefined;
      return data?.status === 'RUNNING' || data?.status === 'PENDING' ? 5000 : false;
    },
  });

  // SSE for real-time progress
  useEffect(() => {
    if (!pentest || (pentest.status !== 'RUNNING' && pentest.status !== 'PENDING')) {
      return;
    }

    const streamUrl = pentestApi.getProgressStreamUrl(pentestId);
    const token = localStorage.getItem('gitscan_token');

    // Create EventSource with auth
    const eventSource = new EventSource(`${streamUrl}?token=${token}`);
    eventSourceRef.current = eventSource;

    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        setProgress(data);

        // If completed, refetch pentest data
        if (data.status === 'COMPLETED' || data.status === 'FAILED') {
          queryClient.invalidateQueries({ queryKey: ['pentest', pentestId] });
          eventSource.close();
        }
      } catch (e) {
        console.error('Error parsing SSE data:', e);
      }
    };

    eventSource.onerror = (error) => {
      console.error('SSE error:', error);
      eventSource.close();
    };

    return () => {
      eventSource.close();
    };
  }, [pentest?.status, pentestId, queryClient]);

  // Cancel pentest mutation
  const cancelPentestMutation = useMutation({
    mutationFn: () => pentestApi.cancelPentest(pentestId),
    onSuccess: () => {
      toast.success('Pentest cancelado');
      queryClient.invalidateQueries({ queryKey: ['pentest', pentestId] });
    },
    onError: () => {
      toast.error('Erro ao cancelar pentest');
    },
  });

  // Get current state from progress or pentest data
  const currentAgent = (progress?.currentAgent || pentest?.currentAgent) as AgentName | null;
  const completedAgents = (progress?.completedAgents || pentest?.completedAgents || []) as AgentName[];
  const skippedAgents = (progress?.skippedAgents || pentest?.skippedAgents || []) as AgentName[];
  const failedAgent = (progress?.failedAgent || pentest?.failedAgent) as AgentName | null;
  const elapsedMs = progress?.elapsedMs || pentest?.totalDurationMs || 0;
  const agentMetrics = (progress?.agentMetrics || {}) as Record<AgentName, { durationMs: number; inputTokens: number | null; outputTokens: number | null; costUsd: number | null; numTurns: number | null; model?: string }>;

  if (loadingPentest) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
      </div>
    );
  }

  if (!pentest) {
    return (
      <div className="text-center py-12">
        <p>Pentest não encontrado</p>
        <Button variant="outline" onClick={() => router.push('/pentest')}>
          Voltar aos Pentests
        </Button>
      </div>
    );
  }

  const isRunning = pentest.status === 'RUNNING' || pentest.status === 'PENDING';
  const isCompleted = pentest.status === 'COMPLETED';
  const isFailed = pentest.status === 'FAILED';

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="icon" onClick={() => router.back()}>
            <ArrowLeft className="h-5 w-5" />
          </Button>
          <div>
            <h1 className="text-2xl font-bold">
              {pentest.repository?.name || 'Pentest'}
            </h1>
            <p className="text-muted-foreground">
              {pentest.webUrl} • Branch: {pentest.branch}
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          {pentest.repository && (
            <a
              href={`https://github.com/${pentest.repository.fullName}`}
              target="_blank"
              rel="noopener noreferrer"
            >
              <Button variant="outline">
                <ExternalLink className="mr-2 h-4 w-4" />
                GitHub
              </Button>
            </a>
          )}
          {isRunning && (
            <Button
              variant="destructive"
              onClick={() => cancelPentestMutation.mutate()}
              disabled={cancelPentestMutation.isPending}
            >
              Cancelar
            </Button>
          )}
        </div>
      </div>

      {/* Status Banner */}
      <Card
        className={
          isCompleted
            ? 'border-green-500/20 bg-green-500/5'
            : isFailed
            ? 'border-destructive/20 bg-destructive/5'
            : 'border-primary/20 bg-primary/5'
        }
      >
        <CardContent className="flex items-center gap-4 p-4">
          <div
            className={`rounded-full p-3 ${
              isCompleted
                ? 'bg-green-500/10'
                : isFailed
                ? 'bg-destructive/10'
                : 'bg-primary/10'
            }`}
          >
            {isCompleted ? (
              <CheckCircle2 className="h-6 w-6 text-green-500" />
            ) : isFailed ? (
              <XCircle className="h-6 w-6 text-destructive" />
            ) : (
              <Loader2 className="h-6 w-6 text-primary animate-spin" />
            )}
          </div>
          <div className="flex-1">
            <h3 className="font-semibold">
              {isCompleted
                ? 'Pentest Concluído'
                : isFailed
                ? 'Pentest Falhou'
                : 'Pentest em Execução'}
            </h3>
            <p className="text-sm text-muted-foreground">
              {isCompleted
                ? `${completedAgents.length} agentes executados com sucesso`
                : isFailed
                ? `Falha no agente: ${failedAgent || 'desconhecido'}`
                : `Executando: ${currentAgent ? AGENTS[currentAgent]?.name : 'Iniciando...'}`}
            </p>
          </div>
          <div className="flex items-center gap-4 text-sm">
            <span className="flex items-center gap-1">
              <Timer className="h-4 w-4" />
              {formatDuration(elapsedMs)}
            </span>
            {pentest.totalCostUsd && (
              <span className="flex items-center gap-1">
                <DollarSign className="h-4 w-4" />
                {formatCost(pentest.totalCostUsd)}
              </span>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Phase Progress */}
      <Card>
        <CardHeader>
          <CardTitle>Progresso do Pipeline</CardTitle>
          <CardDescription>
            {completedAgents.length} de {AGENT_ORDER.length} agentes concluídos
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-6">
            {PHASE_ORDER.map((phaseKey) => {
              const phase = PHASES[phaseKey];
              const phaseAgents = AGENT_ORDER.filter(
                (agent) => AGENTS[agent].phase === phaseKey
              );
              const phaseCompleted = phaseAgents.every(
                (agent) =>
                  completedAgents.includes(agent) || skippedAgents.includes(agent)
              );
              const phaseRunning = phaseAgents.some(
                (agent) => currentAgent === agent
              );
              const phaseFailed = phaseAgents.some(
                (agent) => failedAgent === agent
              );

              return (
                <div key={phaseKey} className="space-y-3">
                  {/* Phase Header */}
                  <div className="flex items-center gap-3">
                    <div
                      className={`flex h-8 w-8 items-center justify-center rounded-full border-2 ${
                        phaseFailed
                          ? 'border-destructive bg-destructive/10 text-destructive'
                          : phaseCompleted
                          ? 'border-green-500 bg-green-500 text-white'
                          : phaseRunning
                          ? 'border-primary bg-primary/10 text-primary'
                          : 'border-muted bg-muted/30 text-muted-foreground'
                      }`}
                    >
                      {phaseCompleted ? (
                        <CheckCircle className="h-4 w-4" />
                      ) : phaseFailed ? (
                        <XCircle className="h-4 w-4" />
                      ) : phaseRunning ? (
                        <Loader2 className="h-4 w-4 animate-spin" />
                      ) : (
                        <Clock className="h-4 w-4" />
                      )}
                    </div>
                    <div>
                      <h4 className="font-semibold">{phase.name}</h4>
                      <p className="text-xs text-muted-foreground">
                        {phase.description}
                      </p>
                    </div>
                  </div>

                  {/* Phase Agents */}
                  <div className="ml-11 flex flex-wrap gap-2">
                    {phaseAgents.map((agentKey) => {
                      const agent = AGENTS[agentKey];
                      const status = getAgentStatus(
                        agentKey,
                        currentAgent,
                        completedAgents,
                        skippedAgents,
                        failedAgent
                      );
                      const Icon = AGENT_ICONS[agentKey];
                      const metrics = agentMetrics[agentKey];

                      return (
                        <div
                          key={agentKey}
                          className={`flex items-center gap-2 rounded-lg border px-3 py-2 text-sm transition-all ${
                            status === 'COMPLETED'
                              ? 'border-green-500/30 bg-green-500/5 text-green-700'
                              : status === 'RUNNING'
                              ? 'border-primary bg-primary/10 text-primary animate-pulse'
                              : status === 'FAILED'
                              ? 'border-destructive/30 bg-destructive/5 text-destructive'
                              : status === 'SKIPPED'
                              ? 'border-muted bg-muted/30 text-muted-foreground line-through'
                              : 'border-muted text-muted-foreground'
                          }`}
                          title={`${agent.name}: ${agent.description}`}
                        >
                          {status === 'RUNNING' ? (
                            <Loader2 className="h-4 w-4 animate-spin" />
                          ) : status === 'COMPLETED' ? (
                            <CheckCircle className="h-4 w-4" />
                          ) : status === 'FAILED' ? (
                            <XCircle className="h-4 w-4" />
                          ) : status === 'SKIPPED' ? (
                            <SkipForward className="h-4 w-4" />
                          ) : (
                            <Icon className="h-4 w-4" />
                          )}
                          <span>{agent.name}</span>
                          {metrics?.durationMs && status === 'COMPLETED' && (
                            <span className="text-xs opacity-60">
                              {formatDuration(metrics.durationMs)}
                            </span>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </CardContent>
      </Card>

      {/* Agent Metrics */}
      {Object.keys(agentMetrics).length > 0 && (
        <Card>
          <CardHeader
            className="cursor-pointer"
            onClick={() => setShowMetrics(!showMetrics)}
          >
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center gap-2">
                <Timer className="h-5 w-5" />
                Métricas dos Agentes
              </CardTitle>
              {showMetrics ? (
                <ChevronUp className="h-5 w-5" />
              ) : (
                <ChevronDown className="h-5 w-5" />
              )}
            </div>
          </CardHeader>
          {showMetrics && (
            <CardContent>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b">
                      <th className="py-2 text-left font-medium">Agente</th>
                      <th className="py-2 text-right font-medium">Duração</th>
                      <th className="py-2 text-right font-medium">Tokens</th>
                      <th className="py-2 text-right font-medium">Custo</th>
                      <th className="py-2 text-right font-medium">Turnos</th>
                      <th className="py-2 text-right font-medium">Modelo</th>
                    </tr>
                  </thead>
                  <tbody>
                    {AGENT_ORDER.filter((a) => agentMetrics[a]).map((agentKey) => {
                      const metrics = agentMetrics[agentKey];
                      const agent = AGENTS[agentKey];
                      return (
                        <tr key={agentKey} className="border-b last:border-0">
                          <td className="py-2 font-medium">{agent.name}</td>
                          <td className="py-2 text-right">
                            {metrics.durationMs
                              ? formatDuration(metrics.durationMs)
                              : '-'}
                          </td>
                          <td className="py-2 text-right">
                            {metrics.inputTokens != null && metrics.outputTokens != null
                              ? `${metrics.inputTokens.toLocaleString()} / ${metrics.outputTokens.toLocaleString()}`
                              : '-'}
                          </td>
                          <td className="py-2 text-right">
                            {metrics.costUsd != null
                              ? formatCost(metrics.costUsd)
                              : '-'}
                          </td>
                          <td className="py-2 text-right">
                            {metrics.numTurns ?? '-'}
                          </td>
                          <td className="py-2 text-right text-muted-foreground">
                            {metrics.model || '-'}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </CardContent>
          )}
        </Card>
      )}

      {/* Report Section */}
      {isCompleted && pentest.pentestReport && (
        <Card>
          <CardHeader
            className="cursor-pointer"
            onClick={() => setShowReport(!showReport)}
          >
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center gap-2">
                <FileText className="h-5 w-5" />
                Relatório Executivo
              </CardTitle>
              {showReport ? (
                <ChevronUp className="h-5 w-5" />
              ) : (
                <ChevronDown className="h-5 w-5" />
              )}
            </div>
          </CardHeader>
          {showReport && (
            <CardContent className="space-y-6">
              {/* Vulnerability Summary */}
              <div>
                <h4 className="font-semibold mb-3">Resumo de Vulnerabilidades</h4>
                <div className="grid grid-cols-5 gap-3">
                  {[
                    { label: 'Críticas', count: pentest.pentestReport.criticalCount, variant: 'critical' },
                    { label: 'Altas', count: pentest.pentestReport.highCount, variant: 'high' },
                    { label: 'Médias', count: pentest.pentestReport.mediumCount, variant: 'medium' },
                    { label: 'Baixas', count: pentest.pentestReport.lowCount, variant: 'low' },
                    { label: 'Info', count: pentest.pentestReport.infoCount, variant: 'secondary' },
                  ].map(({ label, count, variant }) => (
                    <div
                      key={label}
                      className="rounded-lg border p-3 text-center"
                    >
                      <p className="text-xs text-muted-foreground">{label}</p>
                      <p className="text-2xl font-bold">
                        <Badge variant={variant as any} className="text-lg px-3 py-1">
                          {count}
                        </Badge>
                      </p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Exploitation Stats */}
              <div>
                <h4 className="font-semibold mb-3">Exploração</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div className="rounded-lg border p-3">
                    <p className="text-sm text-muted-foreground">Tentativas</p>
                    <p className="text-2xl font-bold">
                      {pentest.pentestReport.exploitsAttempted}
                    </p>
                  </div>
                  <div className="rounded-lg border p-3">
                    <p className="text-sm text-muted-foreground">Bem Sucedidas</p>
                    <p className="text-2xl font-bold text-green-500">
                      {pentest.pentestReport.exploitsSuccessful}
                    </p>
                  </div>
                </div>
              </div>

              {/* Download Button */}
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => {
                    const token = localStorage.getItem('gitscan_token');
                    const pdfUrl = pentestApi.getReportPdfUrl(pentestId);

                    // Fetch PDF with auth header
                    fetch(pdfUrl, {
                      headers: {
                        Authorization: `Bearer ${token}`,
                      },
                    })
                      .then((response) => {
                        if (!response.ok) throw new Error('Erro ao baixar PDF');
                        return response.blob();
                      })
                      .then((blob) => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `pentest-report-${pentestId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        toast.success('Download concluído');
                      })
                      .catch(() => {
                        toast.error('Erro ao baixar relatório');
                      });
                  }}
                >
                  <Download className="mr-2 h-4 w-4" />
                  Baixar Relatório PDF
                </Button>
              </div>
            </CardContent>
          )}
        </Card>
      )}

      {/* Error Message */}
      {isFailed && pentest.error && (
        <Card className="border-destructive/20 bg-destructive/5">
          <CardContent className="p-4">
            <h4 className="font-semibold text-destructive mb-2">Erro</h4>
            <p className="text-sm">{pentest.error}</p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
