'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useQuery, useMutation } from '@tanstack/react-query';
import {
  Shield,
  FolderGit2,
  GitBranch,
  Globe,
  Settings,
  AlertTriangle,
  Target,
  Play,
  FileCode,
  Info,
} from 'lucide-react';
import toast from 'react-hot-toast';
import { repositoryApi, pentestApi } from '@/lib/api';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import type { Repository } from '@/types';
import { AGENT_DEFINITIONS, PHASE_DEFINITIONS } from '@/types';

export default function NewPentestPage() {
  const router = useRouter();
  const [selectedRepo, setSelectedRepo] = useState<string>('');
  const [selectedBranch, setSelectedBranch] = useState<string>('');
  const [webUrl, setWebUrl] = useState<string>('');
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [configYaml, setConfigYaml] = useState<string>('');

  // Fetch repositories
  const { data: repositories, isLoading: loadingRepos } = useQuery({
    queryKey: ['repositories'],
    queryFn: async () => {
      const response = await repositoryApi.listRepos(1, 100);
      return response.data.data as Repository[];
    },
  });

  // Fetch branches for selected repo
  const { data: branches, isLoading: loadingBranches } = useQuery({
    queryKey: ['branches', selectedRepo],
    queryFn: async () => {
      const response = await repositoryApi.getBranches(selectedRepo);
      return response.data.data as Array<{ name: string; protected: boolean }>;
    },
    enabled: !!selectedRepo,
  });

  // Get selected repository details
  const selectedRepository = repositories?.find((r) => r.id === selectedRepo);

  // Set default branch when repo changes
  const handleRepoChange = (repoId: string) => {
    setSelectedRepo(repoId);
    const repo = repositories?.find((r) => r.id === repoId);
    if (repo) {
      setSelectedBranch(repo.defaultBranch);
    }
  };

  // Start pentest mutation
  const startPentestMutation = useMutation({
    mutationFn: () =>
      pentestApi.startPentest({
        repositoryId: selectedRepo,
        webUrl,
        branch: selectedBranch,
        ...(configYaml && { configYaml }),
      }),
    onSuccess: (response) => {
      toast.success('Pentest iniciado com sucesso!');
      router.push(`/pentest/${response.data.data.id}`);
    },
    onError: (error: any) => {
      const message = error.response?.data?.error?.message || 'Erro ao iniciar pentest';
      toast.error(message);
    },
  });

  // Validate URL
  const isValidUrl = (url: string) => {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  };

  const canStart = selectedRepo && selectedBranch && webUrl && isValidUrl(webUrl);

  return (
    <div className="mx-auto max-w-4xl space-y-6">
      {/* Page Header */}
      <div>
        <h1 className="text-3xl font-bold">Novo Pentest</h1>
        <p className="text-muted-foreground">
          Configure e inicie um teste de penetração automatizado
        </p>
      </div>

      {/* Info Banner */}
      <Card className="border-blue-500/20 bg-blue-500/5">
        <CardContent className="flex items-start gap-4 p-4">
          <div className="rounded-full bg-blue-500/10 p-2">
            <Info className="h-5 w-5 text-blue-500" />
          </div>
          <div>
            <h3 className="font-semibold text-blue-500">Como funciona</h3>
            <p className="text-sm text-muted-foreground mt-1">
              O pentest automatizado usa 13 agentes IA especializados para analisar sua aplicação web.
              Os agentes executam em pipeline: análise estática → reconhecimento → detecção de vulnerabilidades →
              exploração → relatório executivo.
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Repository Selection */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <FolderGit2 className="h-5 w-5" />
            Selecione o Repositório
          </CardTitle>
          <CardDescription>
            Escolha qual repositório contém o código-fonte da aplicação
          </CardDescription>
        </CardHeader>
        <CardContent>
          {loadingRepos ? (
            <div className="h-10 animate-pulse rounded-lg bg-muted" />
          ) : repositories?.length ? (
            <div className="grid gap-3 md:grid-cols-2">
              {repositories.map((repo) => (
                <button
                  key={repo.id}
                  onClick={() => handleRepoChange(repo.id)}
                  className={`flex items-center gap-3 rounded-lg border p-4 text-left transition-colors ${
                    selectedRepo === repo.id
                      ? 'border-primary bg-primary/5'
                      : 'hover:bg-muted/50'
                  }`}
                >
                  <FolderGit2 className="h-5 w-5 text-muted-foreground" />
                  <div className="flex-1">
                    <p className="font-medium">{repo.name}</p>
                    <p className="text-xs text-muted-foreground">
                      {repo.language || 'Desconhecido'}
                    </p>
                  </div>
                  {selectedRepo === repo.id && (
                    <Badge variant="default">Selecionado</Badge>
                  )}
                </button>
              ))}
            </div>
          ) : (
            <p className="text-center text-muted-foreground">
              Nenhum repositório adicionado. Adicione um repositório primeiro.
            </p>
          )}
        </CardContent>
      </Card>

      {/* Branch Selection */}
      {selectedRepo && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <GitBranch className="h-5 w-5" />
              Selecione a Branch
            </CardTitle>
            <CardDescription>
              Escolha qual branch contém o código a ser testado
            </CardDescription>
          </CardHeader>
          <CardContent>
            {loadingBranches ? (
              <div className="h-10 animate-pulse rounded-lg bg-muted" />
            ) : branches?.length ? (
              <div className="flex flex-wrap gap-2">
                {branches.map((branch) => (
                  <button
                    key={branch.name}
                    onClick={() => setSelectedBranch(branch.name)}
                    className={`flex items-center gap-2 rounded-lg border px-4 py-2 transition-colors ${
                      selectedBranch === branch.name
                        ? 'border-primary bg-primary/5'
                        : 'hover:bg-muted/50'
                    }`}
                  >
                    <GitBranch className="h-4 w-4" />
                    {branch.name}
                    {branch.protected && (
                      <Badge variant="secondary" className="text-xs">
                        protegida
                      </Badge>
                    )}
                    {branch.name === selectedRepository?.defaultBranch && (
                      <Badge variant="outline" className="text-xs">
                        default
                      </Badge>
                    )}
                  </button>
                ))}
              </div>
            ) : (
              <p className="text-muted-foreground">Nenhuma branch encontrada</p>
            )}
          </CardContent>
        </Card>
      )}

      {/* Web URL */}
      {selectedRepo && selectedBranch && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Globe className="h-5 w-5" />
              URL da Aplicação Web
            </CardTitle>
            <CardDescription>
              Informe a URL onde a aplicação está rodando (ambiente de testes)
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <input
                  type="url"
                  value={webUrl}
                  onChange={(e) => setWebUrl(e.target.value)}
                  placeholder="https://staging.meuapp.com"
                  className="w-full rounded-lg border bg-background px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                />
                {webUrl && !isValidUrl(webUrl) && (
                  <p className="mt-2 text-sm text-destructive flex items-center gap-1">
                    <AlertTriangle className="h-4 w-4" />
                    URL inválida
                  </p>
                )}
              </div>
              <div className="rounded-lg bg-amber-500/10 border border-amber-500/20 p-4">
                <p className="text-sm text-amber-600 flex items-start gap-2">
                  <AlertTriangle className="h-4 w-4 mt-0.5 flex-shrink-0" />
                  <span>
                    <strong>Importante:</strong> Use apenas ambientes de teste/staging.
                    O pentest irá realizar testes de exploração que podem afetar dados.
                  </span>
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Agent Pipeline Preview */}
      {selectedRepo && selectedBranch && webUrl && isValidUrl(webUrl) && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Shield className="h-5 w-5" />
              Pipeline de Agentes
            </CardTitle>
            <CardDescription>
              13 agentes especializados serão executados em sequência
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              {Object.entries(PHASE_DEFINITIONS).map(([phaseKey, phase]) => {
                const phaseAgents = Object.entries(AGENT_DEFINITIONS).filter(
                  ([_, agent]) => agent.phase === phaseKey
                );

                return (
                  <div key={phaseKey}>
                    <h4 className="font-semibold mb-2">{phase.name}</h4>
                    <p className="text-xs text-muted-foreground mb-3">{phase.description}</p>
                    <div className="flex flex-wrap gap-2">
                      {phaseAgents.map(([agentKey, agent]) => (
                        <Badge key={agentKey} variant="outline" className="py-1.5">
                          {agent.name}
                        </Badge>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Advanced Config */}
      {selectedRepo && selectedBranch && webUrl && isValidUrl(webUrl) && (
        <Card>
          <CardHeader
            className="cursor-pointer"
            onClick={() => setShowAdvanced(!showAdvanced)}
          >
            <CardTitle className="flex items-center justify-between">
              <span className="flex items-center gap-2">
                <Settings className="h-5 w-5" />
                Configurações Avançadas
              </span>
              <Badge variant="secondary">{showAdvanced ? 'Ocultar' : 'Mostrar'}</Badge>
            </CardTitle>
            <CardDescription>
              Opcional: configure regras, autenticação e escopo
            </CardDescription>
          </CardHeader>
          {showAdvanced && (
            <CardContent>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Configuração YAML (opcional)
                  </label>
                  <textarea
                    value={configYaml}
                    onChange={(e) => setConfigYaml(e.target.value)}
                    placeholder={`# Exemplo de configuração
rules:
  avoid:
    - type: path
      url_path: /admin/*
  focus:
    - type: path
      url_path: /api/*

authentication:
  login_type: form
  login_url: https://staging.meuapp.com/login
  credentials:
    username: testuser
    password: testpass`}
                    rows={15}
                    className="w-full rounded-lg border bg-background px-4 py-3 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                  />
                </div>
                <p className="text-xs text-muted-foreground">
                  Use YAML para configurar regras de escopo, autenticação e credenciais de teste.
                </p>
              </div>
            </CardContent>
          )}
        </Card>
      )}

      {/* Summary and Start */}
      {selectedRepo && selectedBranch && (
        <Card>
          <CardHeader>
            <CardTitle>Resumo</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="mb-6 space-y-2">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Repositório:</span>
                <span className="font-medium">{selectedRepository?.name}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Branch:</span>
                <span className="font-medium">{selectedBranch}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">URL Alvo:</span>
                <span className="font-medium truncate max-w-xs">{webUrl || '-'}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Agentes:</span>
                <span className="font-medium">13 agentes IA</span>
              </div>
              {configYaml && (
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Config:</span>
                  <Badge variant="secondary">Personalizada</Badge>
                </div>
              )}
            </div>

            <Button
              className="w-full"
              size="lg"
              onClick={() => startPentestMutation.mutate()}
              isLoading={startPentestMutation.isPending}
              disabled={!canStart}
            >
              <Target className="mr-2 h-5 w-5" />
              Iniciar Pentest
            </Button>

            {!canStart && webUrl && !isValidUrl(webUrl) && (
              <p className="mt-2 text-center text-sm text-destructive">
                Corrija a URL antes de iniciar
              </p>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}
